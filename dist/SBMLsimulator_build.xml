<!-- ANT build script for yfiles obfuscation           -->
<!-- The java based ANT tool is available from         -->
<!-- http://jakarta.apache.org/ant                     -->
           	
<project name="SBMLsimulator" default="sign" basedir=".">

  <target name="help">
    <echo>
      This is an ANT build script to build a stand-alone JAR for
	    SBMLsimulator.
	    	
	    The resulting redistributable is the SIGNED jar file,
    	stored in $appJar which is currently "SBMLsimulator.jar".
    </echo>
  </target>

  <!-- define some properties that are used throughout the tasks -->
  <target name="init">
  	<echo>
  	  PLESE MAKE SURE ALL PATHS ARE CORRECT AND DECIDE IF YOU WANT
  	  TO USE THE LIB-JARs OR REFERENCED PROJECTS.
  	</echo>
    <!-- the base directory of the SBMLsimulator repository -->
    <property name="base" location=".."/>
  	
    <!-- the path to the SBMLsimulator sources -->
  	<property name="src" location="${base}/src"/>
  	
    <!-- the path to the SBMLsimulator binaries -->
    <property name="classes" location="${base}/bin"/>
    
    <!-- the unobfuscated application jar file -->
    <property name="appJarRaw" value="SBMLsimulator_unobfuscated.jar"/>
  	
    <!-- the unsigned application jar file -->
    <property name="appJarObf" value="SBMLsimulator_unsigned.jar"/>

    <!-- the FINAL obfuscated signed application jar file -->
    <property name="appJar" value="SBMLsimulator.jar"/>

  	
    <!-- the yGuard jar file containing the obfuscation task -->
    <property name="yGuardJar" value="yguard.jar"/>
    
    <!-- the log file geenrated by the obfuscation task -->
    <property name="obfuscationLog" value="obfuscation-log.xml"/>
    	
    <!-- =================================== -->
    <!-- PATHS TO REFERENCED PROJETS -->
    
    <!-- the path to SYSBIO -->
    <property name="SysBioPath" location="${base}/../SysBio" />
    <!-- the path to JSBML -->
    <property name="JSBMLPath" location="${base}/../jSBML" />
    <!-- the path to SBML2LaTeX -->
    <property name="SBML2LaTeXPath" location="${base}/../SBML2LaTeX" />
    <!-- the path to SBMLsimulatorCore -->
    <property name="SBMLsimulatorCorePath" location="${base}/../SBMLsimulatorCore" />
    <!-- =================================== -->
  	
  </target>

  <!-- puts the application specific classes into application.jar. -->
  <target name="jar" depends="init">
    <delete file="${appJarRaw}"/>
    <jar jarfile="${appJarRaw}">
      <manifest>
        <attribute name="Main-Class" value="org.sbml.simulator.SBMLsimulator"/>
        <attribute name="Built-By" value="Center for Bioinformatics Tuebingen (ZBIT)"/>
        <attribute name="SplashScreen-Image" value="org/sbml/simulator/gui/img/Splash.gif"/>
      </manifest>
    	
    	<!-- SBMLsimulator Classes -->
      <fileset dir="${classes}">
        <exclude name="**/package.html"/>
      </fileset>
    	
    	<!-- All libs without projects at the ZBIT -->
      <zipfileset excludes="META-INF/*.SF" src="${base}/lib/jcommon-1.0.17.jar"/>
      <zipfileset excludes="META-INF/*.SF" src="${base}/lib/jfreechart-1.0.15_beta.jar"/>

      <!-- =================================== -->
      <!-- All libs WITH projects at the ZBIT -->
    	<!-- Every single one of them could be replaced by including the project itself, instead of the jar -->
    	
          <!--<zipfileset excludes="META-INF/*,de/zbit/resources/*,de/zbit/mapper/*,**/package.html,overview.html" src="${base}/lib/sysbio.jar"/> -->
          <fileset dir="${SysBioPath}/bin">
    	      <exclude name="de/zbit/resources/**/*"/>
    	      <exclude name="de/zbit/mapper/**/*"/>
    	      <exclude name="**/package.html"/>
    	      <exclude name="overview.html"/>
    	    </fileset>
          <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/commons-discovery.jar"/>
          <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/commons-logging.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/jaxrpc.jar"/>
          <!-- <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/keggapi.jar"/> -->
          <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/wsdl4j.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/axis.jar"/>
          <!-- <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/Java5/saaj.jar"/>-->
          <!-- <zipfileset excludes="META-INF/*.SF" src="${SysBioPath}/lib/WSDbfetch.jar"/>-->
          <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/commons-cli-1.1.jar"/>
          <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/quaqua.jar"/>
          <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/sysbio-osx-support.jar"/>
    	    <zipfileset excludes="META-INF/*" src="${SysBioPath}/lib/graph/y.jar"/>
    	
          <!--<zipfileset excludes="META-INF/*.SF" src="${base}/lib/SBMLsimulatorCore.jar"/>-->
          <fileset dir="${SBMLsimulatorCorePath}/bin">
            <exclude name="**/package.html"/>
            <exclude name="overview.html"/>
          </fileset>
          	
          <!-- <zipfileset excludes="META-INF/*.SF" src="${base}/lib/SBML2LaTeX-0.9.9_slim.jar"/> -->
    	
          <!--<zipfileset excludes="META-INF/*.SF" src="${base}/lib/jsbml-1.0-a1-with-dependencies.jar"/>-->
          <fileset dir="${JSBMLPath}/bin">
          	<exclude name="log4j.properties"/> <!-- log4j.properties is in SBML2Latex *and* jSBML -->
            <exclude name="**/package.html"/>
            <exclude name="overview.html"/>
          </fileset>
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/biojava-1.7-ontology.jar"/>
          <!-- <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/lib/junit-4.8.jar"/>-->
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/log4j-1.2.8.jar"/>
          <!-- <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/lib/stax-api-1.0.1.jar"/> -->
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/staxmate-2.0.0.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/xstream-1.3.1.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/jigsaw-dateParser.jar"/>
          <zipfileset excludes="META-INF/*.SF" src="${JSBMLPath}/core/lib/stax2-api-3.0.3.jar"/>
          <zipfileset excludes="META-INF/*.SF,META-INF/LICENSE*" src="${JSBMLPath}/core/lib/woodstox-core-lgpl-4.0.9.jar"/>
      
          <zipfileset excludes="META-INF/*.SF" src="${base}/lib/EvA2Base.jar"/>
      <!-- =================================== -->
      
    </jar>
  </target>


  <!-- obfuscates y.jar and adjusts application.jar accordingly. -->
  <!-- Generates the jar files yObf.jar and applicationObf.jar.  -->
  <target name="obfuscate" depends="jar">
    <taskdef name="yguard" classname="com.yworks.yguard.YGuardTask" classpath="${yGuardJar}"/>
    <yguard>

      <!-- obfuscate yFiles for public deployment -->
      <inoutpair in="${appJarRaw}" out="${appJarObf}"/>

      <!-- [OPTIONALLY] Keep the line number table and the source file attributes
                 of the public part of the "application" -->
      <attribute name="LineNumberTable,LocalVariableTable,SourceFile">
        <patternset>
          <include name="de.zbit.**"/>
        </patternset>
      </attribute>

      <rename logfile="${obfuscationLog}" replaceClassNameStrings="true" mainclass="${main}">
        <!-- conservemanifest="true" -->
        <!-- use some unique package prefix for obfuscated classes to avoid name clashes -->
        <property name="obfuscation-prefix" value="obfuscatedintegrator"/>


        <keep>
          <package>
            <patternset>
              <include name="de.**.*"/>
            </patternset>
          </package>

          
             <!-- Keep all method, field, and class names of the "application"             -->
             <!-- This could be adjusted to your needs if you don't want to let            -->
             <!-- your whole application unobfuscated.                                     -->
             <!-- In that case simply add some more "exclude" statements as depicted below -->
             <class classes="private" methods="private" fields="private">
              <patternset>
                <!-- Do not obfuscate anything, by default -->
               <include name="**.*"/>

                <!-- Obfuscate all classes that make use of y.jar -->
              	<!-- We can NOT obfuscate de.zbit.graph.**.*, because there are some resources (labels) in there -->
                <exclude name="de.zbit.graph.*"/>
              	<exclude name="de.zbit.graph.gui.**.*"/>
                <exclude name="de.zbit.graph.io.**.*"/>
              	<exclude name="de.zbit.graph.sbgn.**.*"/>
              	

               <!-- Obfuscate the included y.jar -->
               <exclude name="y.**.*"/>
              </patternset>
             </class>
            
        </keep>

        <!-- make sure that the .properties files are renamed according to their               -->
        <!-- corresponding class files, yFiles needs this to function properly when obfuscated -->
        <adjust replaceName="true">
          <include name="y/**/*.properties"/>
        </adjust>
      </rename>
    </yguard>
  </target>

  <!-- signs the application -->
  <target name="sign" depends="obfuscate">
  	<delete file="${appJar}"/>
    <!-- Having an "keystore" file is required. Generate it with the "keytool" in the current directory. -->  	
	  <signjar alias="SBMLsimulator" jar="${appJarObf}" keypass="d=dpfSBMLsimulator!" keystore="keystore" signedjar="${appJar}" storepass="d=dpfSBMLsimulator!"/>
  </target>

	
  <!-- executes the application -->
  <target name="run" depends="sign">
    <java classname="org.sbml.simulator.SBMLsimulator" fork="true">
      <classpath>
        <pathelement location="${appJar}"/>
      </classpath>
    </java>
  </target>

  <!-- Removes all that has been built -->
  <target name="clean" depends="init">
  	<delete file="${appJarRaw}"/>
  	<delete file="${appJarObf}"/>
    <delete file="${appJar}"/>
    <delete includeemptydirs="true" dir="${classes}"/>
  </target>

</project>
